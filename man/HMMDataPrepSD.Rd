% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/HMMDataPrepSD.R
\name{HMMDataPrepSD}
\alias{HMMDataPrepSD}
\title{Prepare DAM Activity Data for HMM Analysis}
\usage{
HMMDataPrepSD(
  metafile_path,
  result_dir = getwd(),
  ldcyc = 12,
  day_range = c(1, 2),
  sd_day = NULL,
  sd_duration = NULL,
  sd_start_hour = 0,
  ...
)
}
\arguments{
\item{metafile_path}{Character string. Full path to the metadata CSV file
generated by \code{\link{convMasterToMeta}}. This file must contain columns:
\code{file}, \code{start_datetime}, \code{stop_datetime}, \code{region_id},
\code{genotype}, and \code{replicate}.}

\item{result_dir}{Character string. Directory path containing the raw DAM
monitor files referenced in the metadata. Defaults to current working
directory (\code{getwd()}).}

\item{ldcyc}{Numeric. Duration of the light phase in hours within a 24-hour
cycle. For example, use 12 for LD 12:12, or 16 for LD 16:8. Default: 12.
Used to assign time points to "Light" or "Dark" phases.}

\item{day_range}{Numeric vector of length 2. Specifies \code{c(start_day, end_day)}
to retain for analysis (inclusive). Days are numbered starting from 1.
\itemize{
\item Use \code{c(1, 3)} to keep days 1, 2, and 3
\item Use \code{c(2, 2)} to keep only day 2
\item Use \code{c(1, 5)} to keep days 1 through 5
}
Default: \code{c(1, 2)} (first two days).}

\item{sd_day}{Numeric or NULL. Day number on which sleep deprivation occurred.
If NULL (default), no special handling for sleep deprivation is applied.
Example: \code{sd_day = 3} indicates sleep deprivation on day 3.}

\item{sd_duration}{Numeric or NULL. Duration of sleep deprivation in hours.
Only used if \code{sd_day} is specified. Default: NULL.
Example: \code{sd_duration = 12} for 12 hours of sleep deprivation.}

\item{sd_start_hour}{Numeric. Hour within the day when sleep deprivation starts
(0-24, where 0 is the start of the day/ZT0). Default: 0.
Example: \code{sd_start_hour = 12} means SD starts 12 hours into the day.}

\item{...}{Additional arguments passed to \code{\link{sleepDAMAnnotation}}.
Most commonly used:
\describe{
\item{\code{min_time_immobile}}{A vector of length 2 specifying the
minimum and maximum duration (in seconds) for an immobility bout to be
considered sleep. Default: \code{c(behavr::mins(5), behavr::mins(1440))}.
For example, use \code{c(behavr::mins(10), behavr::mins(1440))} to
require 10 minutes of immobility.}
}}
}
\value{
A \code{behavr} table (class \code{behavr} and \code{data.table})
containing processed activity data with both original metadata columns and
newly calculated columns:

\strong{Metadata columns} (from input):
\itemize{
\item \code{id}: Unique identifier for each individual
\item \code{genotype}: Genotype/line identifier
\item \code{replicate}: Replicate identifier
}

\strong{Activity columns} (from DAM files):
\itemize{
\item \code{t}: Time in seconds from experiment start
\item \code{activity}: Raw activity count (beam crossings)
\item \code{asleep}: Logical, sleep state annotation
}

\strong{Calculated columns} (added by this function):
\itemize{
\item \code{moving}: Logical, \code{TRUE} if activity > 0
\item \code{day}: Integer day number (1, 2, 3, ...)
\item \code{phase}: Factor with levels "Light" and "Dark"
\item \code{normact}: Normalized activity as percentage of daily total (0-100)
\item \code{sd_period}: Logical, \code{TRUE} during sleep deprivation period (if applicable)
}
}
\description{
Processes Drosophila Activity Monitor (DAM) data by loading raw monitor files,
linking them with metadata, calculating derived features (day, phase, normalized
activity), and filtering by date range. The output is a \code{behavr} table
ready for Hidden Markov Model analysis.

This is typically the first step in the FlyDreamR workflow, converting raw
DAM files into a standardized format suitable for \code{\link{HMMbehavr}}.
}
\details{
\subsection{Activity Normalization}{

\code{normact} represents activity as a percentage of total daily activity:
\code{normact = (activity / sum(daily_activity)) * 100}

This normalization accounts for individual differences in baseline activity
levels and is used by the HMM fitting process.

\strong{With Sleep Deprivation}: Each period (SD and non-SD) is normalized proportionally
based on its duration. For example, with a 12-hour SD period:
\itemize{
\item SD period: normalized to sum to 50\\% (12/24 * 100)
\item Non-SD period: normalized to sum to 50\\% (12/24 * 100)
\item Total daily normact: 100\\%
}
This maintains the 100\\% total per day while preserving separate normalization
structure for SD vs non-SD periods.
}

\subsection{Sleep Deprivation Handling}{

When \code{sd_day}, \code{sd_duration}, and \code{sd_start_hour} are specified:
\itemize{
\item The sleep deprivation period is normalized separately (as percentage of
activity during that period only)
\item The remaining hours of the SD day are normalized separately (as percentage
of activity during the non-SD period of that day)
\item All other days are normalized normally
\item A new column \code{sd_period} indicates which timepoints fall within the
sleep deprivation period
\item If the SD period extends beyond 24 hours (e.g., starts at hour 18 for 12 hours),
it will span into the next day, and both days will be handled with separate
normalization for SD and non-SD periods
}
}

\subsection{Error Handling}{

The function will stop with an error if:
\itemize{
\item Metadata file doesn't exist or can't be read
\item DAM files referenced in metadata are missing
\item No data remains after day filtering
\item Required columns are missing from loaded data
}
}
}
\examples{
\dontrun{
# Basic usage with default parameters
processed_data <- HMMDataPrepSD(
  metafile_path = "metadata/Metadata_Monitor1.csv"
)

# With sleep deprivation on day 3 for 12 hours starting at hour 12
processed_data <- HMMDataPrepSD(
  metafile_path = "metadata/experiment1_metadata.csv",
  result_dir = "raw_dam_files/",
  day_range = c(1, 5),
  sd_day = 3,
  sd_duration = 12,
  sd_start_hour = 12
)

# Check sleep deprivation period
table(processed_data$sd_period, processed_data$day)
}

}
\seealso{
\code{\link{convMasterToMeta}} for generating metadata files
\code{\link{HMMbehavr}} for running HMM analysis on prepared data
\code{\link{sleepDAMAnnotation}} for sleep annotation details
\code{\link[damr]{load_dam}} for DAM file loading
}
