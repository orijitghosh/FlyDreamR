% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/HMMbehavr.R
\name{HMMbehavr}
\alias{HMMbehavr}
\title{Infer Sleep States Using Hidden Markov Model}
\usage{
HMMbehavr(behavtbl, it = 100, ldcyc = NULL)
}
\arguments{
\item{behavtbl}{A \code{behavr} table (data.frame/data.table) containing
behavioral data. Must include columns: \code{id}, \code{day}, \code{normact}
(normalized activity), \code{genotype}, and \code{t} (time in seconds).
Additional metadata columns (e.g., \code{sex}, \code{treatment}) will be
automatically included in output summaries.
Typically the output from \code{\link{HMMDataPrep}}.}

\item{it}{Integer specifying the number of HMM fitting iterations per
individual per day. Must be >= 100 (enforced). Higher values increase
robustness but require more computation time. Default: 100.

Each iteration fits an HMM with random initialization. The final state
assignment at each time point is determined by majority vote across
all iterations, providing a measure of classification confidence.}

\item{ldcyc}{Numeric value specifying the light phase duration in hours
(e.g., 12 for LD 12:12). If \code{NULL} (default), assumes a 12-hour
light phase. Used to assign "light" and "dark" phase labels to time points.}
}
\value{
A list containing two data frames:
\describe{
\item{\code{TimeSpentInEachState}}{Summary of time (in minutes) spent in
each state, grouped by:
\itemize{
\item \code{ID}: Individual identifier
\item \code{Genotype}: Genotype
\item \code{day}: Day number
\item \code{phase}: Light or dark phase
\item \code{state_name}: State0, State1, State2, or State3
\item \code{time_spent}: Minutes in that state
\item Additional metadata columns (e.g., \code{sex}, \code{treatment})
}
All state-phase combinations are present (filled with 0 if not observed).
}
\item{\code{VITERBIDecodedProfile}}{Time-series of inferred states with columns:
\itemize{
\item \code{timestamp}: Time point index (1 to total time points)
\item \code{state}: Raw HMM state label
\item \code{state_name}: Activity-ordered state name (State0-State3)
\item \code{phase}: Light or dark
\item \code{ID}, \code{Genotype}, \code{day}: Grouping variables
\item Additional metadata columns (e.g., \code{sex}, \code{treatment})
}
}
}
}
\description{
Applies a Hidden Markov Model (HMM) to behavioral activity data to infer
discrete sleep/wake states. The model identifies four behavioral states
(State0-State3) ordered by activity level, where State0 represents the
highest activity (active wake) and State3 represents the lowest activity
(deep sleep).

The function fits an HMM with 4 states using Gaussian emission distributions
for normalized activity levels. Multiple iterations are performed for each
individual and day to ensure robust state inference, with the most frequently
inferred state at each time point selected as the final classification.
}
\details{
\subsection{State Interpretation}{

States are ordered by median activity level:
\itemize{
\item \strong{State0}: Highest activity (active wake)
\item \strong{State1}: Moderate activity (quiet wake)
\item \strong{State2}: Low activity (light sleep)
\item \strong{State3}: Lowest activity (deep sleep)
}
}

\subsection{Failed Cases}{

The function tracks cases where HMM fitting fails or produces invalid results:
\itemize{
\item No valid solution after maximum iterations
\item Single-state dominance (>99\% of time in one state) - indicates
insufficient behavioral variability
}
Failed cases are printed to console and excluded from results.
}

\subsection{Performance Notes}{
\itemize{
\item Progress bar shows overall fitting progress
\item For large datasets, consider using \code{\link{HMMbehavrFast}} for
parallel processing
\item Typical runtime: ~1-2 seconds per individual-day with it=100
}
}
}
\examples{
\dontrun{
# Basic usage with default parameters
hmm_results <- HMMbehavr(behavtbl = processed_data)

# Custom light cycle and more iterations
hmm_results <- HMMbehavr(
  behavtbl = processed_data,
  it = 200,           # More robust inference
  ldcyc = 16          # LD 16:8 cycle
)

# Access results with additional metadata
time_in_states <- hmm_results$TimeSpentInEachState
state_profile <- hmm_results$VITERBIDecodedProfile

# Summarize sleep by sex and genotype
library(dplyr)
sleep_summary <- time_in_states \%>\%
  filter(state_name \%in\% c("State2", "State3")) \%>\%
  group_by(Genotype, sex, day, phase) \%>\%
  summarise(total_sleep_min = sum(time_spent))
}

}
\references{
Ghosh, A., & Harbison, S. T. (2024). Hidden Markov models reveal
heterogeneity in sleep states. (Add actual reference when published)
}
\seealso{
\code{\link{HMMbehavrFast}} for parallel implementation
\code{\link{HMMDataPrep}} for preparing input data
\code{\link{HMMplot}} for visualizing results
\code{\link{HMMFacetedPlot}} for multi-individual visualization
}
