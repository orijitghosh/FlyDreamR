% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/HMMDataPrep.R
\name{HMMDataPrep}
\alias{HMMDataPrep}
\title{Prepare DAM Activity Data for HMM Analysis}
\usage{
HMMDataPrep(
  metafile_path,
  result_dir = getwd(),
  ldcyc = 12,
  day_range = c(1, 2),
  ...
)
}
\arguments{
\item{metafile_path}{Character string. Full path to the metadata CSV file.
Must contain technical columns: \code{file}, \code{start_datetime},
\code{stop_datetime}, \code{region_id}. Any additional columns (e.g.,
\code{genotype}, \code{replicate}, \code{sex}) will be preserved and merged
into the final dataset.}

\item{result_dir}{Character string. Directory path containing the raw DAM
monitor files. Defaults to current working directory.}

\item{ldcyc}{Numeric. Duration of the light phase in hours within a 24-hour
cycle. For example, use 12 for LD 12:12, or 16 for LD 16:8. Default: 12.
Used to assign time points to "Light" or "Dark" phases.}

\item{day_range}{Numeric vector of length 2. Specifies \code{c(start_day, end_day)}
to retain for analysis (inclusive). Days are numbered starting from 1.
\itemize{
\item Use \code{c(1, 3)} to keep days 1, 2, and 3
\item Use \code{c(2, 2)} to keep only day 2
\item Use \code{c(1, 5)} to keep days 1 through 5
}
Default: \code{c(1, 2)} (first two days).}

\item{...}{Additional arguments passed to \code{\link{sleepDAMAnnotation}}.
Most commonly used:
\describe{
\item{\code{min_time_immobile}}{A vector of length 2 specifying the
minimum and maximum duration (in seconds) for an immobility bout to be
considered sleep. Default: \code{c(behavr::mins(5), behavr::mins(1440))}.
For example, use \code{c(behavr::mins(10), behavr::mins(1440))} to
require 10 minutes of immobility.}
}}
}
\value{
A \code{behavr} table (class \code{behavr} and \code{data.table})
containing processed activity data with both original metadata columns and
newly calculated columns:

\strong{Metadata columns} (from input):
\itemize{
\item \code{id}: Unique identifier for each individual, required
\item \code{genotype}: Genotype/line identifier, optional
\item \code{replicate}: Replicate identifier, optional
\item \code{sex}: Sex identifier, optional
}

\strong{Activity columns} (from DAM files):
\itemize{
\item \code{t}: Time in seconds from experiment start
\item \code{activity}: Raw activity count (beam crossings)
\item \code{asleep}: Logical, sleep state annotation
}

\strong{Calculated columns} (added by this function):
\itemize{
\item \code{moving}: Logical, \code{TRUE} if activity > 0
\item \code{day}: Integer day number (1, 2, 3, ...)
\item \code{phase}: Factor with levels "Light" and "Dark"
\item \code{normact}: Normalized activity as percentage of daily total (0-100)
}
}
\description{
Processes Drosophila Activity Monitor (DAM) data by loading raw monitor files,
linking them with metadata, calculating derived features (day, phase, normalized
activity), and filtering by date range. The output is a \code{behavr} table
ready for Hidden Markov Model analysis.

This is typically the first step in the FlyDreamR workflow, converting raw
DAM files into a standardized format suitable for \code{\link{HMMbehavr}}.
}
\details{
\subsection{Metadata File Format**}{

The \code{metadata_file} must be a CSV with one row per fly (channel) and the following columns:
\describe{
\item{\code{file}}{Full filename of the raw monitor file (e.g., "Monitor1.txt").}
\item{\code{start_datetime}}{Experiment start timestamp ("YYYY-MM-DD HH:MM:SS").}
\item{\code{stop_datetime}}{Experiment end timestamp ("YYYY-MM-DD HH:MM:SS").}
\item{\code{region_id}}{Channel number (1-32) on the DAM monitor.}
\item{\code{genotype}}{Experimental genotype identifier.}
\item{\code{replicate}}{Replicate number/value. This is optional.}
\item{\code{sex}}{Sex identifier. This is optional.}
}
}

\subsection{Activity Normalization}{

\code{normact} represents activity as a percentage of total daily activity:
\code{normact = (activity / sum(daily_activity)) * 100}

This normalization accounts for individual differences in baseline activity
levels and is used by the HMM fitting process.
}

\subsection{Error Handling}{

The function will stop with an error if:
\itemize{
\item Metadata file doesn't exist or can't be read
\item DAM files referenced in metadata are missing
\item No data remains after day filtering
\item Required columns are missing from loaded data
}
}
}
\examples{
\dontrun{
# Basic usage with default parameters
processed_data <- HMMDataPrep(
  metafile_path = "metadata/Metadata_Monitor1.csv"
)

# Specify DAM file directory and custom day range
processed_data <- HMMDataPrep(
  metafile_path = "metadata/experiment1_metadata.csv",
  result_dir = "raw_dam_files/",
  day_range = c(2, 4)  # Analyze days 2-4 only
)

# Custom light cycle (LD 16:8) and longer immobility threshold
processed_data <- HMMDataPrep(
  metafile_path = "metadata/experiment2_metadata.csv",
  ldcyc = 16,  # 16 hours of light
  min_time_immobile = c(behavr::mins(10), behavr::mins(1440))  # 10 min threshold
)

# Inspect the output
print(head(processed_data))
summary(processed_data$normact)
table(processed_data$phase, processed_data$day)

# Check data coverage
unique(processed_data$id)  # List all individuals
range(processed_data$day)  # Day range in data
}

}
\seealso{
\code{\link{convMasterToMeta}} for generating metadata files
\code{\link{HMMbehavr}} for running HMM analysis on prepared data
\code{\link{sleepDAMAnnotation}} for sleep annotation details
\code{\link[damr]{load_dam}} for DAM file loading
}
